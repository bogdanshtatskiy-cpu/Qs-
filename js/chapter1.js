// Добавляем сцены в движок
Object.assign(Game.scenes, {
    "start_chapter_1": {
        text: "Ты делаешь резкий вдох, наполняя легкие зловонным воздухом. Глаза слезятся. Первое, что ты видишь — серое небо, затянутое пепельными тучами.<br><br>Ты лежишь в куче трупов. Ощущение, будто по тебе проехалась телега. Все тело ноет. Рядом кто-то копошится, слышно чавканье и звон металла.",
        choices: [
            { text: "Замереть и наблюдать", next: "observe_rat" },
            { text: "Резко сесть и заорать", next: "scare_rat" }
        ]
    },
    
    "observe_rat": {
        text: "Ты приоткрываешь один глаз. Рядом с тобой, сгорбившись над трупом женщины, сидит тощий мужик в лохмотьях. Грязными пальцами он срывает с её шеи золотую цепочку.<br>— Хе-хе, повезло, повезло старой Крысе... — бормочет он, пробуя золото на зуб. Он вооружен ржавым заточкой.",
        choices: [
            { text: "Напасть со спины (Ловкость 4)", req: {stat: 'agility', val: 4}, next: "kill_rat_stealth" },
            { text: "Кашлянуть", next: "rat_notice" }
        ]
    },

    "scare_rat": {
        text: "Ты вскакиваешь, разбрасывая конечности мертвецов, и издаешь дикий вопль.<br>Мародер с визгом отпрыгивает назад, спотыкается о чью-то голову и падает в грязь. Его заточка отлетает в сторону.<br>— Твою мать! Демон! — орет он, крестясь трясущейся рукой.",
        choices: [
            { text: "Поднять его заточку", next: "take_shiv" },
            { text: "— Я не демон, я твоя смерть, сука.", next: "intimidate_rat" }
        ]
    },

    "rat_notice": {
        text: "Мародер вздрагивает и резко оборачивается, выставляя перед собой заточку.<br>— Живой?! А ну лежи, падаль! У меня, бля, нервы ни к черту!<br>Он выглядит напуганным, но опасным. Глаза бегают.",
        choices: [
            { text: "— Спокойно. Я просто хочу уйти.", next: "diplomacy_fail" },
            { text: "(Харизма 4) — Эй, приятель. Тут добра на всех хватит. Зачем нам кровь?", req: {stat: 'charisma', val: 4}, next: "rat_friend" },
            { text: "Броситься на него", next: "fight_rat" }
        ]
    },

    "take_shiv": {
        onEnter: (s) => { 
            s.hero.inventory.push("Ржавая заточка"); 
            s.hero.stats.strength += 1; // Бонус за оружие
        },
        text: "Ты перехватываешь ржавое лезвие. Оно тяжелое и грубое. Теперь ты хозяин положения.<br>Мародер смотрит на тебя снизу вверх.<br>— Эй... мужик... не надо. Забирай ботинки, только не убивай!",
        choices: [
            { text: "Убить его (Это Пустоши, детка)", next: "kill_rat_execution" },
            { text: "— Проваливай.", next: "rat_flees" }
        ]
    },

    "fight_rat": {
        text: "Ты бросаешься на него с голыми руками. Он тычет заточкой наугад.",
        choices: [
            { text: "Увернуться и ударить (Ловкость)", next: "fight_win" },
            { text: "Принять удар на себя (Сила)", next: "fight_dmg" }
        ]
    },

    "fight_dmg": {
        onEnter: (s) => { s.hero.hp -= 30; },
        text: "Лезвие входит тебе в плечо. Боль адская. -30 HP.<br>Но ты хватаешь его за горло и сжимаешь изо всех сил. Хруст позвонков звучит как музыка.",
        choices: [
            { text: "Обыскать тело", next: "loot_rat" }
        ]
    },
    
    "kill_rat_stealth": {
        text: "Одно точное движение — и шея мародера свернута. Он даже не пискнул. Ты настоящий хищник.",
        onEnter: (s) => { s.hero.stats.agility += 1; }, // Прокачка
        choices: [
            { text: "Обыскать труп", next: "loot_rat" }
        ]
    },

    "loot_rat": {
        onEnter: (s) => { s.hero.inventory.push("Кусок хлеба", "Золотая цепочка"); },
        text: "В карманах у него нашелся черствый хлеб и та самая цепочка. Негусто, но на первый раз сойдет.",
        choices: [
            { text: "Идти к Городу", next: "city_gate" }
        ]
    },

    "death": {
        text: "Ты умер.", // Это перенаправит на handleDeath в движке
        choices: []
    },

    "bonfire_respawn": {
        text: "Ты открываешь глаза у тлеющего костра посреди поля трупов. Голова гудит. Твое тело помнит боль смерти, но Метка заставила сердце биться снова.<br>Ты чувствуешь, что потерял часть своей души.",
        choices: [
            { text: "Встать и продолжить путь", next: "start_chapter_1" } // Возврат в начало или чекпоинт
        ]
    },
    
    "city_gate": {
        text: "Впереди возвышаются черные стены Цитадели. Ворота закрыты, перед ними стоят два стражника в тяжелой броне.<br>— Стой, оборванец! Вход только для граждан или за плату. 50 монет или проваливай.",
        choices: [
            { text: "У меня нет денег", next: "gate_fail" },
            { text: "Показать золотую цепочку", req: {stat: 'inventory', val: 'Золотая цепочка'}, next: "gate_bribe" } // Это псевдокод, нужно допилить проверку предмета в движке
        ]
    },
    
    // Заглушка для продолжения
    "gate_fail": {
        text: "— Тогда сдохни в канаве.<br>Стражник наводит на тебя арбалет.",
        choices: [
             { text: "Бежать", next: "start_chapter_1" }, // Временная петля для теста
             { text: "Попробовать магию Метки (Секрет)", next: "magic_burst" }
        ]
    },
    
    "magic_burst": {
         text: "Ты чувствуешь жжение в руке. Это не магия, это чистая энтропия. Ты вытягиваешь руку, и стражника просто разрывает изнутри.<br>Ты теряешь сознание от истощения.",
         onEnter: (s) => { s.hero.sanity += 50; },
         choices: [ {text: "...", next: "death"} ]
    }
});

// Инициализация (если движок уже загружен)
if(window.Game) Game.init();
