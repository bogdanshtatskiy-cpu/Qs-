/* ГЛАВА 3: ГОРОД ОТВЕРЖЕННЫХ
   Локация: Подземный лагерь повстанцев
   Механики: Торговля, Азартные игры, Лор
*/

Object.assign(Game.scenes, {
    
    // Точка входа из концовки 2-й главы
    "ch3_start_real": {
        text: "Таверна 'Пьяная Жаба' встречает тебя гулом голосов, запахом дешевого эля и жареного крысиного мяса. Это сердце Города Отверженных. Здесь, под защитой древних стен коллектора, собрались воры, дезертиры и беглые маги.\n\nОдноглазый бармен протирает кружку грязной тряпкой. В углу играют в кости. У камина сидит мрачный человек в капюшоне.",
        choices: [
            { text: "Подойти к бармену", next: "ch3_barman" },
            { text: "Сыграть в кости (Нужны деньги)", next: "ch3_dice_game" },
            { text: "Подойти к человеку у камина (Сайлас)", next: "ch3_silas_intro" }
        ]
    },

    // --- БАРМЕН И СЛУХИ ---
    "ch3_barman": {
        text: "Бармен окидывает тебя взглядом единственного глаза: 'Новое лицо. Или беглец, или безумец. Чего хочешь?'",
        choices: [
            { text: "Спросить про слухи", next: "ch3_rumors" },
            { text: "Есть что выпить? (-2 золотых)", next: "ch3_drink_ale" },
            { text: "Отойти", next: "ch3_start_real" }
        ]
    },

    "ch3_rumors": {
        text: "'Говорят, Император болен. 'Бледная Хворь', так шепчут. А Инквизиция лютует, ищет какого-то 'Носителя Метки'. Говорят, он может открывать двери, запечатанные Кровью Богов. Глупости.'",
        choices: [
            { text: "Интересно... (Назад)", next: "ch3_barman" }
        ]
    },

    "ch3_drink_ale": {
        text: "Ты бросаешь монеты. Эль на вкус как моча гоблина, но он согревает и притупляет боль.",
        // Тут нужна проверка золота, но пока упростим
        actions: [{type: "heal", val: 5}, {type: "rep", faction: "Мятежники", val: 1}],
        choices: [
            { text: "Спасибо. (Назад)", next: "ch3_barman" }
        ]
    },

    // --- МИНИ-ИГРА: КОСТИ ---
    "ch3_dice_game": {
        text: "За столом сидит щербатый наемник. 'Эй, свежее мясо! Хочешь испытать удачу? Ставка 10 монет. Выкинешь больше меня — заберешь 20.'",
        choices: [
            { text: "Играть (Рискнуть 10 золотых)", next: "ch3_dice_roll" },
            { text: "Я пас", next: "ch3_start_real" }
        ]
    },

    "ch3_dice_roll": {
        text: "Ты бросаешь кости...",
        actions: [], 
        // Здесь мы используем простую рандомизацию через сцены.
        // В будущем можно добавить random() прямо в логику кнопок движка.
        // Пока сделаем через псевдо-выбор, так как движок детерминирован.
        // ХАК: Мы перепишем текст этой сцены динамически при рендере в следующей версии движка.
        // Сейчас просто сделаем ветвление 50/50 через скрытую логику игрока (он не знает итог).
        choices: [
            { text: "Бросить кости!", next: Math.random() > 0.5 ? "ch3_dice_win" : "ch3_dice_lose" } 
        ]
    },

    "ch3_dice_win": {
        text: "Твои кости: 6 и 5. Его кости: 2 и 4.\n'Тьфу ты! Повезло новичку', — наемник швыряет тебе кошель.",
        actions: [{type: "addItem", item: "Золото (20)"}, {type: "xp", val: 5}],
        choices: [{ text: "Сыграть еще", next: "ch3_dice_game" }, { text: "Уйти", next: "ch3_start_real" }]
    },

    "ch3_dice_lose": {
        text: "Твои кости: 1 и 3. Его кости: 5 и 4.\nНаемник ухмыляется и сгребает твои монеты.",
        choices: [{ text: "Отыграться", next: "ch3_dice_game" }, { text: "Уйти", next: "ch3_start_real" }]
    },

    // --- САЙЛАС И СЮЖЕТ ---
    "ch3_silas_intro": {
        text: "Человек у камина поднимает голову. Его лицо пересекает шрам. Это Сайлас, лидер местного сопротивления.\n'Я не знаю тебя. Зачем ты ищешь встречи?'",
        choices: [
            { text: "Показать кольцо 'Расколотый щит'", next: "ch3_silas_ring" },
            { text: "Я хочу вступить в ряды мятежников", next: "ch3_silas_join" }
        ]
    },

    "ch3_silas_ring": {
        text: "Сайлас берет кольцо. Его руки дрожат.\n'Это кольцо капитана Варика. Он пропал 10 лет назад в Серых Пустошах... Если оно у тебя, значит, ты или убил его, или сама судьба привела тебя сюда.'\n\nОн возвращает кольцо. 'Носи его скрытно. Инквизиторы сдерут с тебя кожу живьем, если увидят'.",
        actions: [{type: "rep", faction: "Мятежники", val: 20}, {type: "xp", val: 50}],
        choices: [
            { text: "Что мне теперь делать?", next: "ch3_mission_brief" }
        ]
    },

    "ch3_silas_join": {
        text: "'Мятежники? Мы не мятежники, парень. Мы выжившие. Империя хочет нас уничтожить. Если хочешь быть с нами — докажи полезность.'",
        choices: [
            { text: "Я готов выполнить задание", next: "ch3_mission_brief" }
        ]
    },

    "ch3_mission_brief": {
        text: "Сайлас разворачивает карту на столе.\n'Мы в осаде. Имперцы перекрыли выходы на поверхность. Но есть Старый Шлюз на востоке. Он ведет в Заброшенный Квартал города.\n\nПроблема в том, что шлюз охраняет Тварь из Бездны. Нам нужен кто-то безумный, кто проберется туда и откроет вентили, чтобы смыть имперские патрули водой'.",
        choices: [
            { text: "Я сделаю это", next: "ch3_accept_mission" },
            { text: "Звучит как самоубийство. Какая плата?", next: "ch3_haggle_mission" }
        ]
    },

    "ch3_haggle_mission": {
        text: "'Плата — твоя жизнь. Если мы не откроем шлюз, нас всех перебьют через два дня. Но... если вернешься, я дам тебе доспехи из черной стали'.",
        choices: [
            { text: "По рукам", next: "ch3_accept_mission" }
        ]
    },

    "ch3_accept_mission": {
        text: "'Хорошо. Перед выходом зайди к нашему кузнецу, Грогу. Скажи, что я прислал. Тебе понадобится снаряжение получше тюремных лохмотьев'.",
        choices: [
            { text: "Идти к кузнецу", next: "ch3_blacksmith" }
        ]
    },

    // --- МАГАЗИН (КУЗНЕЦ) ---
    "ch3_blacksmith": {
        text: "Кузница наполнена жаром. Огромный орк бьет молотом по раскаленному металлу. Это Грог.\n'Сайлас прислал? Хм. Ты выглядишь хилым. Тебе нужна броня'.\n\n(Торговля пока упрощена: ты получаешь стартовый набор повстанца)",
        actions: [
            {type: "addItem", item: "Кожаная куртка (+2 Защиты)"}, 
            {type: "addItem", item: "Заточенный меч (+3 Атаки)"},
            {type: "xp", val: 10}
        ],
        choices: [
            { text: "Надеть снаряжение и выдвигаться", next: "ch3_departure" },
            { text: "Спросить про оружие получше", next: "ch3_blacksmith_rare" }
        ]
    },

    "ch3_blacksmith_rare": {
        text: "'Есть у меня один клинок... Из 'звездного металла'. Но он стоит дорого. Принеси мне голову Твари со Шлюза, и я выкую тебе меч, который сможет убивать призраков'.",
        choices: [
            { text: "Запомнить это", next: "ch3_departure" }
        ]
    },

    // --- ФИНАЛ ГЛАВЫ 3 ---
    "ch3_departure": {
        text: "Ты стоишь у массивной гермодвери, ведущей в восточные тоннели. За спиной — Город Отверженных. Впереди — темнота, сырость и Тварь, о которой говорили шепотом.\n\nТы проверяешь оружие. Пути назад нет.",
        choices: [
            { text: "Открыть гермодверь (Начать Главу 4)", next: "ch4_start" }
        ]
    }
});
